name: Build and Deploy BirthdayBuddyLeftChatBot

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: TelegramBotRunners
    environment: production

    steps:
      # üîÅ –®–∞–≥ 1: –ö–ª–æ–Ω–∏—Ä—É–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
      - name: Checkout code
        uses: actions/checkout@v4
        # ‚Üí –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤—Å–µ —Ñ–∞–π–ª—ã –µ—Å—Ç—å –≤ —Ä–∞–±–æ—á–µ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (Runner —Å–æ–∑–¥–∞—ë—Ç –≤—Ä–µ–º–µ–Ω–Ω—É—é —Ä–∞–±–æ—á—É—é –ø–∞–ø–∫—É /home/runner/_work/BirthdayBuddyLeftChat/BirthdayBuddyLeftChat)

      # ‚öôÔ∏è –®–∞–≥ 2: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: '8.0.x'

      # üõ†Ô∏è –®–∞–≥ 3: –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      - name: Restore dependencies
        run: dotnet restore

      # üõ†Ô∏è –®–∞–≥ 4: –°–æ–±–∏—Ä–∞–µ–º –∏ –ø—É–±–ª–∏–∫—É–µ–º
      - name: Build and Publish
        run: |
          dotnet publish \
          --configuration Release \
          --output ./publish \
          --nologo \
          --verbosity minimalse

      # üìÅ –®–∞–≥ 5: –ö–æ–ø–∏—Ä—É–µ–º Settings.json (–µ—Å–ª–∏ –Ω–µ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
      - name: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        run: cp Settings.json ./publish/ || echo "Warning: Settings.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"

      # üöÄ –®–∞–≥ 6: –î–µ–ø–ª–æ–π –Ω–∞ —Ü–µ–ª–µ–≤–æ–π —Å–µ—Ä–≤–µ—Ä
      - name: –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        run: |
          
          # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          # scp -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -r ./publish/* root@telegram.local:/root/publish/BirthdayBuddyLeftChat/

      # üîÅ –®–∞–≥ 7 –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
      - name: –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞
        run: systemctl restart BirthdayBuddyLeftChat.service

      # üöÄ –®–∞–≥ 8 –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
      - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
        run: systemctl status BirthdayBuddyLeftChat.service --no-pager